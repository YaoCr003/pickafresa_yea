# Vision Service Configuration
# Always-on vision system with persistent RealSense pipeline
#
# @aldrick-t, 2025

# ==============================================================================
# SERVICE CONFIGURATION
# ==============================================================================
service:
  name: "pickafresa_vision_service"
  auto_start: true                # Auto-start with robot CLI
  port: 5555                      # IPC socket port for communication
  host: "localhost"               # Service host
  timeout_sec: 30.0               # Timeout for capture requests
  
  # Reconnection settings for RealSense pipeline
  reconnect:
    enabled: true                 # Auto-reconnect if pipeline fails
    max_attempts: 5               # Maximum reconnection attempts
    retry_delay_sec: 2.0          # Delay between reconnection attempts
    
  # Frame buffering
  buffer:
    enabled: true                 # Enable frame buffering
    size: 5                       # Number of frames to buffer
    drop_old: true                # Drop old frames if buffer full

# ==============================================================================
# PREVIEW WINDOW CONFIGURATION
# ==============================================================================
preview:
  enabled: true                  # Show preview window (can be toggled at runtime)
  window_name: "PickaFresa Vision Service"
  fps: 30                         # Target FPS for preview
  
  # Display layout
  layout:
    mode: "side_by_side"          # Options: "side_by_side", "overlay", "stacked"
    rgb_width: 640                # RGB display width
    depth_width: 640              # Depth display width
    
  # RGB display options
  rgb:
    show_detections: true         # Overlay detection bboxes
    show_confidence: true         # Show confidence scores
    show_class: true              # Show class labels
    show_depth: true              # Show depth measurement
    show_xyz: true                # Show XYZ position
    show_axes: true               # Show 3D pose axes on fruit
    bbox_color: [0, 255, 0]       # BGR color for bboxes
    bbox_thickness: 2             # Bbox line thickness
    text_color: [255, 255, 255]   # BGR color for text
    text_scale: 0.6               # Text scale factor
    axes_length_mm: 50.0          # Length of 3D axes in mm
    
  # Depth display options
  depth:
    colormap: "jet"               # OpenCV colormap: "jet", "hot", "cool", "rainbow", "bone"
    user_adjustable: true         # Allow user to adjust colormap at runtime
    show_scale: true              # Show depth scale bar
    min_depth_m: 0.1              # Minimum depth for colormap
    max_depth_m: 3.0              # Maximum depth for colormap
    overlay_alpha: 0.6            # Alpha for depth overlay on RGB (0-1)
    
  # Info display
  info:
    show_fps: true                # Show FPS counter
    show_timestamp: true          # Show timestamp
    show_frame_count: true        # Show frame number
    show_detection_count: true    # Show number of detections
    show_status: true             # Show service status
    position: "top_left"          # Position: "top_left", "top_right", "bottom_left", "bottom_right"

# ==============================================================================
# CAPTURE SETTINGS
# ==============================================================================
capture:
  # When robot requests a capture
  mode: "on_demand"               # Options: "on_demand" (robot request), "continuous" (always capturing)
  
  # Multi-frame capture for averaging
  multi_frame:
    enabled: false                # Use multi-frame averaging (set by pnp_calc_config.yaml)
    inter_frame_delay_ms: 50      # Delay between frames (to reduce correlation)
    stabilization_frames: 2       # Number of frames to discard before capturing
    
  # Capture retry settings
  retry:
    enabled: true                 # Retry failed captures
    max_attempts: 5               # Maximum retry attempts
    delay_sec: 0.5                # Delay between retries
    
  # Save captured data
  save_captures:
    enabled: true                # Save captures to disk
    directory: "pickafresa_vision/captures"
    save_rgb: true                # Save RGB images
    save_depth: true              # Save depth data
    save_json: true               # Save detection/PnP results as JSON
    timestamp_format: "%Y%m%d_%H%M%S"

# ==============================================================================
# INFERENCE SETTINGS
# ==============================================================================
inference:
  # Model configuration
  model_path: "pickafresa_vision/models/18k_oct19_yolo11_70x.pt"  # Path to YOLO model
  confidence_threshold: 0.6      # Minimum confidence for detections
  iou_threshold: 0.45             # IoU threshold for NMS
  device: "cpu"                   # Device: "cpu", "cuda", "mps"
  
  # Detection filtering
  filter:
    target_classes: ["ripe"]      # Only process these classes
    min_bbox_area: 100            # Minimum bbox area in pixels
    max_bbox_area: 250000         # Maximum bbox area in pixels
    
# ==============================================================================
# PNP CALCULATION
# ==============================================================================
pnp:
  config_path: "pickafresa_vision/configs/pnp_calc_config.yaml"
  auto_compute: true              # Automatically compute PnP for detections
  cache_results: false            # Cache PnP results (not recommended for moving camera)

# ==============================================================================
# LOGGING
# ==============================================================================
logging:
  # Log file settings
  log_directory: "pickafresa_vision/logs"
  log_filename: "vision_service.log"  # Fixed filename (overwritten on start)
  log_level: "DEBUG"              # File logging level: DEBUG, INFO, WARNING, ERROR
  
  # Console output
  console_level: "INFO"           # Console logging level (typically less verbose)
  log_to_console: true            # Also log to console
  
  # File management
  overwrite_on_start: true        # Overwrite log file on each service start (no history)
  
  # ROS2-style formatting (if available)
  use_ros2_format: true           # Use ROS2-style logger if available
  node_name: "vision_service"     # Node name in log messages
  format: "[%(levelname)s] [%(name)s] %(message)s"  # Fallback format if ROS2 logger unavailable
  
  # Performance logging
  performance:
    enabled: true                 # Log timing information
    log_every_n_frames: 30        # Log performance every N frames
    track_metrics:
      - "capture_time"            # Time to capture frame
      - "inference_time"          # Time to run detection
      - "pnp_time"                # Time to compute PnP
      - "total_time"              # Total processing time
      - "fps"                     # Frames per second

# ==============================================================================
# KEYBOARD SHORTCUTS (when preview enabled)
# ==============================================================================
keyboard:
  quit: "q"                       # Quit service
  toggle_preview: "p"             # Toggle preview window
  toggle_depth_overlay: "d"       # Toggle depth overlay
  cycle_colormap: "c"             # Cycle through depth colormaps
  save_frame: "s"                 # Save current frame
  increase_depth_max: "]"         # Increase max depth range
  decrease_depth_max: "["         # Decrease max depth range
  reset_view: "r"                 # Reset view settings
  toggle_fps: "f"                 # Toggle FPS display
  toggle_axes: "a"                # Toggle 3D axes display
